<script>

let audioContext;
let musicSource;
let musicGain;
let timer = null;
let isRunning = false;
let intervalTime = 8000;

const steps = [
  "1-step.mp3",
  "2-step.mp3",
  "3-step.mp3",
  "4-step.mp3",
  "5-step.mp3",
  "6-step.mp3",
  "7-step.mp3",
  "8-step.mp3",
  "9-step.mp3",
  "cc.mp3",
  "hook.mp3",
  "toprock.mp3",
  "power.mp3",
  "freeze.mp3"
];

async function initAudio() {

  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const music = document.getElementById("music");
    musicSource = audioContext.createMediaElementSource(music);

    musicGain = audioContext.createGain();
    musicGain.gain.value = 0.25;
    musicSource.connect(musicGain).connect(audioContext.destination);
  }

  await audioContext.resume();
}

async function playStep(file) {

  const response = await fetch(file);
  const arrayBuffer = await response.arrayBuffer();
  const buffer = await audioContext.decodeAudioData(arrayBuffer);

  const source = audioContext.createBufferSource();
  source.buffer = buffer;

  const gainNode = audioContext.createGain();
  gainNode.gain.value = 1.5; 

  source.connect(gainNode).connect(audioContext.destination);


  musicGain.gain.value = 0.05;

  source.start(0);

  source.onended = () => {
    musicGain.gain.value = 0.25;
  };
}

async function startTraining() {

  if (isRunning) return;
  isRunning = true;

  await initAudio();

  const music = document.getElementById("music");
  music.play();

  timer = setInterval(() => {

    const random = steps[Math.floor(Math.random() * steps.length)];
    playStep(random);

  }, intervalTime);
}

function stopTraining() {

  isRunning = false;

  if (timer !== null) {
    clearInterval(timer);
    timer = null;
  }

  const music = document.getElementById("music");
  music.pause();
}

</script>
